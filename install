---
# This is the Jekyll Front Matter: https://jekyllrb.com/docs/frontmatter
#
# This file will be parsed and generated by GitHub Pages (which is using Jekyll)
# to replace the "{{ ... }}" variables by the actual values corresponding to the$
# current repository.
#
# So this repository can be safely forked because every URLs are dynamically
# generated.
#
---
# This script does not have a shebang interpreter line because it is intended to
# be explicitly piped like this:
#
#     wget -qO- {{ site.github.url }}/install | sudo sh

# Enable the "exit on error" option.
set -e

# Create a temporary directory.
tmp="$(mktemp --directory)"

# Remove the temporary directory when leaving.
trap "rm --recursive ${tmp}" EXIT

# Helper to check if a package is installed.
installed() { dpkg --status $@ >/dev/null 2>&1; }

# Get the system state.
[ -n "${SUDO_USER}" ]	&& user="${SUDO_USER}"	|| user="$(id --name --user)"
[ -n "${SUDO_UID}" ]	&& uid="${SUDO_UID}"	|| uid="$(id --user)"
[ -n "${SUDO_GID}" ]	&& gid="${SUDO_GID}"	|| gid="$(id --group)"

home="$(awk 'BEGIN { FS=":" } /'${user}'/ {print $6}' /etc/passwd)"

[ "$(id --user)" = 0 ] && root=y || root=n

installed task-desktop && desktop=y || desktop=n

if [ "${root}" = y ]
then
	# Clean apt source file and activate contrib and non-free.
	sed --in-place \
		--expression '/^#/d' \
		--expression '/^\s*$/d' \
		--expression 's/^\(.*main\)/\1 contrib non-free/' \
		/etc/apt/sources.list

	# Install tools.
	apt update
	apt install --assume-yes \
		bash-completion \
		curl \
		file \
		less \
		lsb-release \
		lsof \
		man-db \
		manpages \
		net-tools \
		tree \
		bzip2 \
		p7zip-full \
		p7zip-rar \
		rar \
		unrar \
		unzip \
		xz-utils \
		zip \
		astyle \
		autoconf \
		automake \
		build-essential \
		cmake \
		gdb \
		git \
		libncurses5-dev \
		libtool \
		minicom \
		pkg-config \
		python \
		repo \
		valgrind \
		vim
fi

# Download and extract the GitHub resources in the temporary directory.
wget	--output-document "${tmp}/github.tar.gz" \
	--quiet "{{ site.github.tar_url }}"

tar	--directory ${tmp} \
	--transform "s:^[^/]*:.:" \
	--extract --gzip --file "${tmp}/github.tar.gz"

# Install them for the current user.
install	--mode 640 \
	--owner "${uid}" \
	--group "${gid}" \
	--target-directory "${home}" \
	"${tmp}/.bashrc" \
	"${tmp}/.bash_logout" \
	"${tmp}/.dircolors" \
	"${tmp}/.gitconfig" \
	"${tmp}/.profile"
